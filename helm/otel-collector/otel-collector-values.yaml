# OpenTelemetry Collector Helm Chart Values
# Chart: open-telemetry/opentelemetry-collector
# Purpose: Telemetry data receiver and processor

# Image configuration (required)
image:
  repository: otel/opentelemetry-collector-contrib
  tag: ""  # Use chart default

# Deployment mode
mode: deployment

# Replicas
replicaCount: 1

# Resource limits (30% reduced from requirements)
resources:
  requests:
    cpu: 140m
    memory: 358Mi
  limits:
    cpu: 700m
    memory: 1.4Gi

# Presets - enable Kubernetes attributes processor with RBAC
presets:
  kubernetesAttributes:
    enabled: true

# Use custom config
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318

  processors:
    batch:
      timeout: 10s
      send_batch_size: 1024

    memory_limiter:
      check_interval: 1s
      limit_mib: 512

    resource:
      attributes:
        - key: cluster.name
          value: k3s-cluster
          action: insert

  exporters:
    # Traces → Tempo
    otlp/tempo:
      endpoint: tempo:4317
      tls:
        insecure: true

    # Metrics → Prometheus (remote write)
    prometheusremotewrite:
      endpoint: http://prometheus-server:80/api/v1/write
      tls:
        insecure: true

    # Debug exporter for troubleshooting
    debug:
      verbosity: normal

  service:
    telemetry:
      metrics:
        readers:
          - pull:
              exporter:
                prometheus:
                  host: 0.0.0.0
                  port: 8888

    pipelines:
      traces:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, resource, batch]
        exporters: [otlp/tempo, debug]

      metrics:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, resource, batch]
        exporters: [prometheusremotewrite, debug]

# Service ports
ports:
  otlp:
    enabled: true
    containerPort: 4317
    servicePort: 4317
    hostPort: 4317
    protocol: TCP
  otlp-http:
    enabled: true
    containerPort: 4318
    servicePort: 4318
    protocol: TCP
  metrics:
    enabled: true
    containerPort: 8888
    servicePort: 8888
    protocol: TCP

# Service type
service:
  type: ClusterIP

# Annotations for Prometheus scraping (meta-monitoring)
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8888"
  prometheus.io/path: "/metrics"
